{% extends "layouts/app.html" %}

{% block title %}{{ project.name }} - {{ app_name }}{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex items-center justify-between">
        <div>
            <p class="text-gray-600 text-sm">
                <a href="/namespaces" class="text-blue-600 hover:underline">å‘½åç©ºé—´</a> /
                <a href="/namespaces/{{ namespace.id }}" class="text-blue-600 hover:underline">{{ namespace.name }}</a> /
            </p>
            <h1>{{ project.name }}</h1>
            <p class="text-gray-500 mt-1">{{ project.description or 'æ— æè¿°' }}</p>
        </div>
        <div class="flex gap-2">
            <a href="/namespaces/{{ namespace.id }}/projects/{{ project.id }}/edit" class="btn-secondary">ç¼–è¾‘</a>
        </div>
    </div>
</div>

<!-- Silence Banner -->
{% if project.is_silenced() %}
<div class="alert alert-warning mb-6 flex items-center justify-between">
    <div>
        <span class="font-medium">ğŸ”‡ é¡¹ç›®å·²é™é»˜</span>
        <span class="ml-2">å‰©ä½™æ—¶é—´ï¼š{{ project.silence_remaining() }}</span>
    </div>
    <form method="POST" action="/namespaces/{{ namespace.id }}/projects/{{ project.id }}/unsilence" class="inline">
        <button type="submit" class="btn-secondary text-sm">å–æ¶ˆé™é»˜</button>
    </form>
</div>
{% endif %}

<!-- Webhook URL -->
<div class="card mb-6">
    <div class="card-header">
        <h2>Webhook é…ç½®</h2>
    </div>
    <div class="space-y-2">
        <div>
            <label class="text-sm text-gray-500">Webhook URL</label>
            <div class="flex items-center gap-2 mt-1">
                <code class="text-sm bg-gray-100 px-2 py-1 flex-1 break-all">{{ base_url }}/webhook/{{ namespace.slug }}/{{ project.id }}</code>
            </div>
        </div>
        <div>
            <label class="text-sm text-gray-500">è¯·æ±‚ç¤ºä¾‹</label>
            <code class="text-xs bg-gray-100 px-2 py-1 block mt-1">POST {{ base_url }}/webhook/{{ namespace.slug }}/{{ project.id }}?source=grafana</code>
        </div>
    </div>
</div>

<!-- Project Info -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
    <div class="card">
        <div class="card-header">
            <h2>é¡¹ç›®ä¿¡æ¯</h2>
        </div>
        <table class="table">
            <tbody>
                <tr>
                    <td class="font-medium w-32">çŠ¶æ€</td>
                    <td>
                        {% if project.is_active %}
                        <span class="badge badge-green">å¯ç”¨</span>
                        {% else %}
                        <span class="badge badge-gray">ç¦ç”¨</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="font-medium">åˆ›å»ºæ—¶é—´</td>
                    <td>{{ project.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="card">
        <div class="card-header">
            <h2>å‡çº§ç­–ç•¥</h2>
        </div>
        <table class="table">
            <tbody>
                <tr>
                    <td class="font-medium w-32">çŠ¶æ€</td>
                    <td>
                        {% if project.escalation_config.enabled %}
                        <span class="badge badge-green">å¯ç”¨</span>
                        {% else %}
                        <span class="badge badge-gray">ç¦ç”¨</span>
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <td class="font-medium">è¶…æ—¶æ—¶é—´</td>
                    <td>{{ project.escalation_config.timeout_minutes }} åˆ†é’Ÿ</td>
                </tr>
                <tr>
                    <td class="font-medium">å‡çº§è·¯å¾„</td>
                    <td>{{ bound_groups|length }} çº§</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="card">
        <div class="card-header">
            <h2>é™é»˜æ§åˆ¶</h2>
        </div>
        <div class="p-3">
            {% if project.is_silenced() %}
            <div class="text-center">
                <div class="text-orange-600 font-medium mb-2">ğŸ”‡ å·²é™é»˜</div>
                <div class="text-sm text-gray-500 mb-3">å‰©ä½™ {{ project.silence_remaining() }}</div>
                <form method="POST" action="/namespaces/{{ namespace.id }}/projects/{{ project.id }}/unsilence">
                    <button type="submit" class="btn-secondary w-full">å–æ¶ˆé™é»˜</button>
                </form>
            </div>
            {% else %}
            <form method="POST" action="/namespaces/{{ namespace.id }}/projects/{{ project.id }}/silence">
                <div class="mb-3">
                    <label class="form-label">é™é»˜æ—¶é•¿</label>
                    <div class="radio-group">
                        {% for minutes, label in silence_options %}
                        <input type="radio" id="silence_{{ minutes }}" name="duration" value="{{ minutes }}" {{ 'checked' if loop.first else '' }}>
                        <label for="silence_{{ minutes }}">{{ label }}</label>
                        {% endfor %}
                    </div>
                </div>
                <button type="submit" class="btn-secondary w-full">ğŸ”‡ å¼€å§‹é™é»˜</button>
                <p class="text-xs text-gray-500 mt-2">é™é»˜æœŸé—´ä¸å‘é€é€šçŸ¥ï¼Œä½†ä»åˆ›å»ºå·¥å•</p>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<!-- Test Message -->
<div class="card mb-6">
    <div class="card-header">
        <h2>å‘é€æµ‹è¯•æ¶ˆæ¯</h2>
    </div>
    {% if test_result %}
    <div class="p-3 border-b border-gray-200 {% if test_result.success %}bg-green-50{% else %}bg-red-50{% endif %}">
        <div class="flex items-start gap-2">
            {% if test_result.success %}
            <span class="text-green-600">âœ“</span>
            <div>
                <p class="font-medium text-green-700">{{ test_result.message }}</p>
                {% if test_result.details %}
                <ul class="text-sm text-green-600 mt-1">
                    {% for channel, success in test_result.details.items() %}
                    <li>{{ channel }}: {% if success %}æˆåŠŸ{% else %}å¤±è´¥{% endif %}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            {% else %}
            <span class="text-red-600">âœ—</span>
            <div>
                <p class="font-medium text-red-700">{{ test_result.message }}</p>
                {% if test_result.details %}
                <ul class="text-sm text-red-600 mt-1">
                    {% for channel, success in test_result.details.items() %}
                    <li>{{ channel }}: {% if success %}æˆåŠŸ{% else %}å¤±è´¥{% endif %}</li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    <form method="POST" action="/namespaces/{{ namespace.id }}/projects/{{ project.id }}/test" class="p-3">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <div>
                <label class="form-label">æ ‡é¢˜</label>
                <input type="text" name="title" class="form-input" placeholder="æµ‹è¯•å‘Šè­¦" value="">
            </div>
            <div>
                <label class="form-label">ä¸¥é‡çº§åˆ«</label>
                <select name="severity" class="form-input">
                    {% for value, label in severity_options %}
                    <option value="{{ value }}" {{ 'selected' if value == 'warning' else '' }}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex items-end">
                <button type="submit" class="btn-primary">ğŸ“¤ å‘é€æµ‹è¯•</button>
            </div>
        </div>
        <div>
            <label class="form-label">æè¿°</label>
            <textarea name="description" class="form-input" rows="2" placeholder="è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼Œç”¨äºéªŒè¯é€šçŸ¥é…ç½®æ˜¯å¦æ­£ç¡®ã€‚"></textarea>
        </div>
        <p class="text-xs text-gray-500 mt-2">æµ‹è¯•æ¶ˆæ¯å°†å‘é€åˆ°ç¬¬ä¸€çº§é€šçŸ¥ç»„ï¼ˆ{{ bound_groups[0].name if bound_groups else 'æœªé…ç½®' }}ï¼‰ï¼Œä¸ä¼šåˆ›å»ºå®é™…å·¥å•ã€‚</p>
    </form>
</div>

<!-- Notification Groups (Bound) -->
<div class="card">
    <div class="card-header flex items-center justify-between">
        <h2>é€šçŸ¥ç»„ï¼ˆå‡çº§è·¯å¾„ï¼‰</h2>
        <a href="/namespaces/{{ namespace.id }}/projects/{{ project.id }}/edit" class="btn-secondary text-sm">ç¼–è¾‘ç»‘å®š</a>
    </div>
    {% if bound_groups %}
    <table class="table">
        <thead>
            <tr>
                <th>é¡ºåº</th>
                <th>åç§°</th>
                <th>æ¸ é“é…ç½®</th>
            </tr>
        </thead>
        <tbody>
            {% for group in bound_groups %}
            <tr>
                <td>
                    <span class="badge badge-blue">{{ loop.index }}</span>
                </td>
                <td class="font-medium">
                    <a href="/notification-groups/{{ group.id }}/edit" class="text-blue-600 hover:underline">{{ group.name }}</a>
                </td>
                <td>
                    {% for config in group.channel_configs %}
                    <div class="text-sm mb-1">
                        <span class="badge badge-gray">{{ config.type.value }}</span>
                        {% for contact_id in config.contact_ids %}
                        {% set contact = contacts_map.get(contact_id) %}
                        {% if contact %}
                        <span class="text-gray-600">{{ contact.name }}</span>{% if not loop.last %}, {% endif %}
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% endfor %}
                    {% if not group.channel_configs %}
                    <span class="text-gray-400">æœªé…ç½®</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div class="p-3 text-xs text-gray-500 border-t border-gray-200">
        å·¥å•åˆ›å»ºæ—¶é€šçŸ¥ç¬¬ 1 çº§ï¼Œè¶…æ—¶æœªç¡®è®¤åˆ™ä¾æ¬¡å‡çº§åˆ°ä¸‹ä¸€çº§ã€‚
    </div>
    {% else %}
    <p class="text-gray-500 text-sm p-4">æš‚æœªç»‘å®šé€šçŸ¥ç»„ï¼Œè¯·<a href="/namespaces/{{ namespace.id }}/projects/{{ project.id }}/edit" class="text-blue-600 hover:underline">ç¼–è¾‘é¡¹ç›®</a>æ·»åŠ é€šçŸ¥ç»„</p>
    {% endif %}
</div>
{% endblock %}
