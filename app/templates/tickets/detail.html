{% extends "layouts/app.html" %}

{% block title %}å·¥å•è¯¦æƒ… - {{ app_name }}{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="flex items-center justify-between">
        <div>
            <p class="text-gray-600 text-sm">
                <a href="/tickets" class="text-blue-600 hover:underline">å·¥å•</a> /
            </p>
            <h1>{{ ticket.title or '(æ— æ ‡é¢˜)' }}</h1>
            <p class="text-gray-500 mt-1">
                {% if ticket.status.value == 'pending' %}
                <span class="badge badge-yellow">å¾…å¤„ç†</span>
                {% elif ticket.status.value == 'acknowledged' %}
                <span class="badge badge-blue">å·²ç¡®è®¤</span>
                {% elif ticket.status.value == 'escalated' %}
                <span class="badge badge-red">å·²å‡çº§</span>
                {% else %}
                <span class="badge badge-green">å·²è§£å†³</span>
                {% endif %}
                <span class="ml-2">{{ ticket.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </p>
        </div>
        <div class="flex gap-2">
            {% if ticket.status.value == 'pending' or ticket.status.value == 'escalated' %}
            <form method="POST" action="/tickets/{{ ticket.id }}/ack">
                <button type="submit" class="btn-success">ç¡®è®¤å·¥å•</button>
            </form>
            {% endif %}
            {% if ticket.status.value != 'resolved' %}
            <form method="POST" action="/tickets/{{ ticket.id }}/resolve">
                <button type="submit" class="btn-secondary">æ ‡è®°è§£å†³</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Main content -->
    <div class="lg:col-span-2 space-y-6">
        <!-- Description -->
        <div class="card">
            <div class="card-header">
                <h2>æè¿°</h2>
            </div>
            {% if ticket.description %}
            <p class="text-sm whitespace-pre-wrap">{{ ticket.description }}</p>
            {% else %}
            <p class="text-gray-500 text-sm">æ— æè¿°</p>
            {% endif %}
        </div>
        
        <!-- Labels -->
        {% if ticket.labels %}
        <div class="card">
            <div class="card-header">
                <h2>æ ‡ç­¾</h2>
            </div>
            <div class="flex flex-wrap gap-2">
                {% for key, value in ticket.labels.items() %}
                <span class="badge badge-gray">{{ key }}={{ value }}</span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- Payload -->
        <div class="card">
            <div class="card-header">
                <h2>åŸå§‹æ•°æ®</h2>
            </div>
            <pre class="text-xs bg-gray-100 p-3 overflow-x-auto rounded-sm">{{ ticket.payload | tojson(indent=2) }}</pre>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Info -->
        <div class="card">
            <div class="card-header">
                <h2>åŸºæœ¬ä¿¡æ¯</h2>
            </div>
            <table class="table">
                <tbody>
                    <tr>
                        <td class="font-medium w-24">æ¥æº</td>
                        <td><span class="badge badge-gray">{{ ticket.source }}</span></td>
                    </tr>
                    <tr>
                        <td class="font-medium">ä¸¥é‡çº§åˆ«</td>
                        <td>
                            {% if ticket.severity %}
                            {% if ticket.severity == 'critical' %}
                            <span class="badge badge-red">{{ ticket.severity }}</span>
                            {% elif ticket.severity == 'warning' %}
                            <span class="badge badge-yellow">{{ ticket.severity }}</span>
                            {% else %}
                            <span class="badge badge-gray">{{ ticket.severity }}</span>
                            {% endif %}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="font-medium">å‡çº§çº§åˆ«</td>
                        <td>{{ ticket.escalation_level }}</td>
                    </tr>
                    <tr>
                        <td class="font-medium">é€šçŸ¥æ¬¡æ•°</td>
                        <td>{{ ticket.notification_count }}</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- Project -->
        {% if project %}
        <div class="card">
            <div class="card-header">
                <h2>æ‰€å±é¡¹ç›®</h2>
            </div>
            <table class="table">
                <tbody>
                    <tr>
                        <td class="font-medium w-24">å‘½åç©ºé—´</td>
                        <td>
                            {% if namespace %}
                            <a href="/namespaces/{{ namespace.id }}" class="text-blue-600 hover:underline">{{ namespace.name }}</a>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="font-medium">é¡¹ç›®</td>
                        <td>
                            <a href="/namespaces/{{ namespace.id }}/projects/{{ project.id }}" class="text-blue-600 hover:underline">{{ project.name }}</a>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        {% endif %}
        
        <!-- Timeline -->
        <div class="card">
            <div class="card-header">
                <h2>äº‹ä»¶æ—¶é—´çº¿</h2>
            </div>
            <div class="space-y-3 text-sm max-h-96 overflow-y-auto">
                {% for event in ticket.events %}
                <div class="flex items-start gap-2 pb-3 {% if not loop.last %}border-b border-gray-100{% endif %}">
                    {% if event.type.value == 'created' %}
                    <span class="w-2 h-2 mt-1.5 rounded-full bg-gray-400 flex-shrink-0"></span>
                    <div class="min-w-0">
                        <p class="font-medium">åˆ›å»ºå·¥å•</p>
                        <p class="text-gray-500 text-xs">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% if event.details %}<p class="text-gray-400 text-xs truncate">{{ event.details }}</p>{% endif %}
                    </div>
                    {% elif event.type.value == 'notified' %}
                    <span class="w-2 h-2 mt-1.5 rounded-full {% if event.success %}bg-blue-400{% else %}bg-red-400{% endif %} flex-shrink-0"></span>
                    <div class="min-w-0">
                        <p class="font-medium">
                            å‘é€é€šçŸ¥
                            {% if event.group_name %}<span class="text-gray-500 font-normal">[{{ event.group_name }}]</span>{% endif %}
                            {% if event.success %}<span class="text-green-600 text-xs ml-1">âœ“</span>{% else %}<span class="text-red-600 text-xs ml-1">âœ— å¤±è´¥</span>{% endif %}
                        </p>
                        <p class="text-gray-500 text-xs">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }} Â· çº§åˆ« {{ event.level }}</p>
                        {% if event.details %}<p class="text-gray-400 text-xs truncate" title="{{ event.details }}">{{ event.details }}</p>{% endif %}
                    </div>
                    {% elif event.type.value == 'notified_silenced' %}
                    <span class="w-2 h-2 mt-1.5 rounded-full bg-orange-400 flex-shrink-0"></span>
                    <div class="min-w-0">
                        <p class="font-medium text-orange-600">ğŸ”‡ é€šçŸ¥è¢«é™é»˜</p>
                        <p class="text-gray-500 text-xs">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% if event.details %}<p class="text-gray-400 text-xs truncate">{{ event.details }}</p>{% endif %}
                    </div>
                    {% elif event.type.value == 'repeated' %}
                    <span class="w-2 h-2 mt-1.5 rounded-full {% if event.success %}bg-blue-300{% else %}bg-red-300{% endif %} flex-shrink-0"></span>
                    <div class="min-w-0">
                        <p class="font-medium">
                            é‡å¤é€šçŸ¥
                            {% if event.group_name %}<span class="text-gray-500 font-normal">[{{ event.group_name }}]</span>{% endif %}
                            {% if event.success %}<span class="text-green-600 text-xs ml-1">âœ“</span>{% else %}<span class="text-red-600 text-xs ml-1">âœ— å¤±è´¥</span>{% endif %}
                        </p>
                        <p class="text-gray-500 text-xs">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }} Â· çº§åˆ« {{ event.level }}</p>
                        {% if event.details %}<p class="text-gray-400 text-xs truncate" title="{{ event.details }}">{{ event.details }}</p>{% endif %}
                    </div>
                    {% elif event.type.value == 'escalated' %}
                    <span class="w-2 h-2 mt-1.5 rounded-full {% if event.success %}bg-orange-500{% else %}bg-red-500{% endif %} flex-shrink-0"></span>
                    <div class="min-w-0">
                        <p class="font-medium text-orange-600">
                            å‡çº§åˆ°
                            {% if event.group_name %}<span class="font-normal">[{{ event.group_name }}]</span>{% endif %}
                            {% if event.success %}<span class="text-green-600 text-xs ml-1">âœ“</span>{% else %}<span class="text-red-600 text-xs ml-1">âœ— å¤±è´¥</span>{% endif %}
                        </p>
                        <p class="text-gray-500 text-xs">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }} Â· çº§åˆ« {{ event.level }}</p>
                        {% if event.details %}<p class="text-gray-400 text-xs truncate" title="{{ event.details }}">{{ event.details }}</p>{% endif %}
                    </div>
                    {% elif event.type.value == 'max_level_reached' %}
                    <span class="w-2 h-2 mt-1.5 rounded-full bg-gray-500 flex-shrink-0"></span>
                    <div class="min-w-0">
                        <p class="font-medium text-gray-600">åˆ°è¾¾æœ€é«˜çº§åˆ«</p>
                        <p class="text-gray-500 text-xs">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% if event.details %}<p class="text-gray-400 text-xs truncate">{{ event.details }}</p>{% endif %}
                    </div>
                    {% elif event.type.value == 'acknowledged' %}
                    <span class="w-2 h-2 mt-1.5 rounded-full bg-green-400 flex-shrink-0"></span>
                    <div class="min-w-0">
                        <p class="font-medium text-green-600">âœ“ å·²ç¡®è®¤ {% if event.details %}<span class="font-normal text-gray-600">{{ event.details }}</span>{% endif %}</p>
                        <p class="text-gray-500 text-xs">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                    {% elif event.type.value == 'resolved' %}
                    <span class="w-2 h-2 mt-1.5 rounded-full bg-green-600 flex-shrink-0"></span>
                    <div class="min-w-0">
                        <p class="font-medium text-green-700">å·²è§£å†³</p>
                        <p class="text-gray-500 text-xs">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% if event.details %}<p class="text-gray-400 text-xs truncate">{{ event.details }}</p>{% endif %}
                    </div>
                    {% else %}
                    <span class="w-2 h-2 mt-1.5 rounded-full bg-gray-300 flex-shrink-0"></span>
                    <div class="min-w-0">
                        <p class="font-medium">{{ event.type.value }}</p>
                        <p class="text-gray-500 text-xs">{{ event.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                        {% if event.details %}<p class="text-gray-400 text-xs truncate">{{ event.details }}</p>{% endif %}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p class="text-gray-400 text-sm">æš‚æ— äº‹ä»¶è®°å½•</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
